<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Developer documentation &#8212; MLPP 0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="top" title="MLPP 0.1 documentation" href="../index.html" />
    <link rel="prev" title="API reference" href="../api/index.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          MLPP</a>
        <span class="navbar-text navbar-version pull-left"><b>0.1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../z_tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../inference/index.html">Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../simulation/index.html">Simulation toolbox [<code class="docutils literal"><span class="pre">mlpp.simulation</span></code>]</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optim/index.html">Optimization toolbox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API reference</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Developer documentation</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Developer documentation</a><ul>
<li><a class="reference internal" href="#main-highlights">Main highlights</a></li>
<li><a class="reference internal" href="#base-class">Base class</a><ul>
<li><a class="reference internal" href="#read-only-attributes">Read-only attributes</a><ul>
<li><a class="reference internal" href="#behavior">Behavior</a></li>
<li><a class="reference internal" href="#how-to-set-it-manually">How to set it manually?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#settable-attributes">Settable attributes</a></li>
<li><a class="reference internal" href="#link-with-c-setter">Link with C++ setter</a></li>
<li><a class="reference internal" href="#how-does-this-work">How does this work?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-add-a-new-model-solver-or-prox">How to add a new model, solver or prox</a><ul>
<li><a class="reference internal" href="#create-c-class">Create C++ class</a></li>
<li><a class="reference internal" href="#link-it-with-python">Link it with Python</a><ul>
<li><a class="reference internal" href="#create-swig-file">Create SWIG file</a></li>
<li><a class="reference internal" href="#reference-it-in-python-build">Reference it in Python build</a></li>
</ul>
</li>
<li><a class="reference internal" href="#use-class-in-python">Use class in Python</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="../api/index.html" title="Previous Chapter: API reference"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; API reference</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/dev/index.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="developer-documentation">
<h1>Developer documentation<a class="headerlink" href="#developer-documentation" title="Permalink to this headline">¶</a></h1>
<div class="section" id="main-highlights">
<h2>Main highlights<a class="headerlink" href="#main-highlights" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><strong>Python 3 only</strong>!</li>
<li>Fast, most computation are done in C++11 (including multi-threading)</li>
<li>Interplay between Python and C++ is done using swig</li>
</ul>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#developer-documentation" id="id1">Developer documentation</a><ul>
<li><a class="reference internal" href="#main-highlights" id="id2">Main highlights</a></li>
<li><a class="reference internal" href="#base-class" id="id3">Base class</a><ul>
<li><a class="reference internal" href="#read-only-attributes" id="id4">Read-only attributes</a></li>
<li><a class="reference internal" href="#settable-attributes" id="id5">Settable attributes</a></li>
<li><a class="reference internal" href="#link-with-c-setter" id="id6">Link with C++ setter</a></li>
<li><a class="reference internal" href="#how-does-this-work" id="id7">How does this work?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-add-a-new-model-solver-or-prox" id="id8">How to add a new model, solver or prox</a><ul>
<li><a class="reference internal" href="#create-c-class" id="id9">Create C++ class</a></li>
<li><a class="reference internal" href="#link-it-with-python" id="id10">Link it with Python</a></li>
<li><a class="reference internal" href="#use-class-in-python" id="id11">Use class in Python</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="base-class">
<span id="baseclass"></span><h2>Base class<a class="headerlink" href="#base-class" title="Permalink to this headline">¶</a></h2>
<p>Most of our objects inherit from <code class="xref py py-obj docutils literal"><span class="pre">mlpp.base.Base</span></code> class. If this class does
not have many public methods, it allow us to benefit from several behaviors.
These behaviors are deducted from a private dictionary set by developer :
<code class="xref py py-obj docutils literal"><span class="pre">_attrinfos</span></code>.</p>
<div class="section" id="read-only-attributes">
<h3>Read-only attributes<a class="headerlink" href="#read-only-attributes" title="Permalink to this headline">¶</a></h3>
<div class="section" id="behavior">
<h4>Behavior<a class="headerlink" href="#behavior" title="Permalink to this headline">¶</a></h4>
<p>The first feature is the ability to set read-only attributes. If you think
end-user should not modify an attribute of your class, you can simply set
writable to False (writable is True by default).</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">_attrinfos</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;readonly_attr&#39;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;writable&#39;</span> <span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
</pre></div>
</div>
<p>Then if you try to set it</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">readonly_attr</span> <span class="o">=</span> <span class="mi">3</span>
<span class="gt">Traceback (most recent call last):</span>
  <span class="c">...</span>
<span class="gr">AttributeError</span>: <span class="n">readonly_attr is readonly in A</span>
</pre></div>
</div>
</div>
<div class="section" id="how-to-set-it-manually">
<h4>How to set it manually?<a class="headerlink" href="#how-to-set-it-manually" title="Permalink to this headline">¶</a></h4>
<p>First if you set a read-only attribute during the initialization phase (ie.
in <code class="xref py py-obj docutils literal"><span class="pre">__init__</span></code> method or in a method called by it) you will not raise any error.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">_attrinfos</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;readonly_attr&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;writable&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">readonly_value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readonly_attr</span> <span class="o">=</span> <span class="n">readonly_value</span>
</pre></div>
</div>
<p>This code snippet will work as usual.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">readonly_attr</span>
<span class="go">5</span>
</pre></div>
</div>
<p>But if you need to change this attribute after the initialization phase, you
can force set it by using <code class="xref py py-obj docutils literal"><span class="pre">_set</span></code> method.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;readonly_attr&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">readonly_attr</span>
<span class="go">10</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="settable-attributes">
<h3>Settable attributes<a class="headerlink" href="#settable-attributes" title="Permalink to this headline">¶</a></h3>
<p>Base class also restricts which attributes can be set. Attributes that can be
set are:</p>
<ul class="simple">
<li>Attributes contained in <code class="xref py py-obj docutils literal"><span class="pre">_attrinfos</span></code> dictionary</li>
<li>Attributes documented in class docstring (with numpydoc style)</li>
<li>Attributes passed as argument to <code class="xref py py-obj docutils literal"><span class="pre">__init__</span></code></li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">When you document an attribute with numpydoc style, do not forget the
space before the colon that follow its name.</p>
</div>
<p>Hence, if an attribute was never mentioned in your class before, trying to
set it will raise an exception.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is an awesome class that inherits from Base</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    documented_parameter : `int`</span>
<span class="sd">        This is a documented parameter of my class</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    documented_attribute : `string`</span>
<span class="sd">        This is a documented attribute of my class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_attrinfos</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;attr_in_attrinfos&#39;</span> <span class="p">:</span> <span class="p">{}</span>
    <span class="p">}</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">documented_parameter</span><span class="p">,</span> <span class="n">undocumented_parameter</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
<p>The following will work as expected</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">documented_parameter</span> <span class="o">=</span> <span class="mi">32</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">documented_attribute</span> <span class="o">=</span> <span class="s1">&#39;bananas&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">undocumented_parameter</span> <span class="o">=</span> <span class="s1">&#39;are too many&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">documented_parameter</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">documented_attribute</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">undocumented_parameter</span>
<span class="go">(32, &#39;bananas&#39;, &#39;are too many&#39;)</span>
</pre></div>
</div>
<p>But this raises an error</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">unexisting_attr</span> <span class="o">=</span> <span class="mi">25</span>
<span class="gt">Traceback (most recent call last):</span>
 <span class="c">...</span>
<span class="gr">AttributeError</span>: <span class="n">&#39;A&#39; object has no settable attribute &#39;unexisting_attr&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="link-with-c-setter">
<h3>Link with C++ setter<a class="headerlink" href="#link-with-c-setter" title="Permalink to this headline">¶</a></h3>
<p>Another useful feature is the possibility to add a direct linking between a
Python attribute and its C++ equivalent.</p>
<p>In many cases our code consists in a Python object which encompasses a C++
object used for intense computations. Find more details in the SWIG part
of this documentation. In this setting we might want to update our C++ object
each time our Python object is. We can do so by specifying which setter to
call when an attribute is modified in Python.</p>
<p>For this example, let&#8217;s suppose we have a C++ class (named <code class="xref py py-obj docutils literal"><span class="pre">_A</span></code>) that has a int
attribute associated to a setter (<code class="xref py py-obj docutils literal"><span class="pre">set_cpp_int</span></code>) and a getter (<code class="xref py py-obj docutils literal"><span class="pre">get_cpp_int</span></code>).
In order to enable the linking we must specify:</p>
<ul class="simple">
<li>What is the C++ object&#8217;s name, through <code class="xref py py-obj docutils literal"><span class="pre">_cpp_obj_name</span></code> attribute of the class</li>
<li>What is the C++ method that sets attribute <code class="xref py py-obj docutils literal"><span class="pre">cpp_int</span></code>, through <code class="xref py py-obj docutils literal"><span class="pre">cpp_setter</span></code>
in <code class="xref py py-obj docutils literal"><span class="pre">_attrinfos</span></code> dictionary</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">_attrinfos</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;cpp_int&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;cpp_setter&#39;</span><span class="p">:</span> <span class="s1">&#39;set_cpp_int&#39;</span><span class="p">},</span>
        <span class="s1">&#39;_a&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;writable&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
    <span class="p">}</span>
    <span class="n">_cpp_obj_name</span> <span class="o">=</span> <span class="s2">&quot;_a&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_a</span> <span class="o">=</span> <span class="n">_A</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpp_int</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Now each time we will modify <code class="xref py py-obj docutils literal"><span class="pre">cpp_int</span></code> attribute of an instance of the class
<code class="xref py py-obj docutils literal"><span class="pre">A</span></code>, <code class="xref py py-obj docutils literal"><span class="pre">set_cpp_int</span></code> method of the C++ object will be called and modify the
value of the C++ int.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">cpp_int</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">_a</span><span class="o">.</span><span class="n">get_cpp_int</span><span class="p">()</span>
<span class="go">(0, 0)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">cpp_int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">cpp_int</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">_a</span><span class="o">.</span><span class="n">get_cpp_int</span><span class="p">()</span>
<span class="go">(-4, -4)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If the reader wants to run this example, he might find the corresponding
class by importing it <code class="xref py py-obj docutils literal"><span class="pre">from</span> <span class="pre">mlpp.base.utils.build.utils</span> <span class="pre">import</span> <span class="pre">A0</span> <span class="pre">as</span> <span class="pre">_A</span></code>.</p>
</div>
</div>
<div class="section" id="how-does-this-work">
<h3>How does this work?<a class="headerlink" href="#how-does-this-work" title="Permalink to this headline">¶</a></h3>
<p>This class behavior is obtained thanks to Python metaclasses. A metaclass is
the object that is called to create the class object itself. For example, it
allow us to automatize property creation. For more information, please report
to <a class="reference external" href="https://docs.python.org/3/reference/datamodel.html#customizing-class-creation">Python documentation</a>.</p>
<p>What we do is creating a property for each attribute. This property is linked
to a hidden attribute, stored with the same name of the property with a
double underscore before</p>
<p>If we create the following class <code class="xref py py-obj docutils literal"><span class="pre">A</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr</span> <span class="o">=</span> <span class="n">attr</span>
</pre></div>
</div>
<p>We have access to the property <code class="xref py py-obj docutils literal"><span class="pre">attr</span></code> and its linked attribute <code class="xref py py-obj docutils literal"><span class="pre">__attr</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">attr</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">__attr</span>
<span class="go">(15, 15)</span>
</pre></div>
</div>
<p>Two good practises to avoid unexpected behaviors:</p>
<ul class="simple">
<li>Do not define an attribute that starts with a double underscore</li>
<li>Add property documentation in class docstring instead of property getter</li>
</ul>
</div>
</div>
<div class="section" id="how-to-add-a-new-model-solver-or-prox">
<h2>How to add a new model, solver or prox<a class="headerlink" href="#how-to-add-a-new-model-solver-or-prox" title="Permalink to this headline">¶</a></h2>
<p>Many of our models, prox and solvers are Python classes that wraps a C++ class
which handles the heavy computations. This allows us to have a code that runs
fast.</p>
<p>Let&#8217;s see what we should do if we want to add prox L2. Adding a model or a
solver is basically identical.</p>
<div class="section" id="create-c-class">
<h3>Create C++ class<a class="headerlink" href="#create-c-class" title="Permalink to this headline">¶</a></h3>
<p>First we need to create the C++ class that will be wrapped by our Python
class later. We want our prox to be able to give the value of the
penalization at a given point and call the proximal operator on a given vector.</p>
<p>Here is what our .h file should look like</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ProxL2Sq</span> <span class="p">{</span>

<span class="k">protected</span><span class="o">:</span>
    <span class="kt">double</span> <span class="n">strength</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
    <span class="n">ProxL2Sq</span><span class="p">(</span><span class="kt">double</span> <span class="n">strength</span><span class="p">);</span>
    <span class="kt">double</span> <span class="nf">value</span><span class="p">(</span><span class="n">ArrayDouble</span> <span class="o">&amp;</span><span class="n">coeffs</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="kt">void</span> <span class="nf">call</span><span class="p">(</span><span class="n">ArrayDouble</span> <span class="o">&amp;</span><span class="n">coeffs</span><span class="p">,</span> <span class="kt">double</span> <span class="n">step</span><span class="p">,</span> <span class="n">ArrayDouble</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_strength</span><span class="p">(</span><span class="kt">double</span> <span class="n">strength</span><span class="p">){</span>
        <span class="k">this</span><span class="o">-&gt;</span><span class="n">strength</span> <span class="o">=</span> <span class="n">strength</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Basically we have one constructor that set the only one parameter strength
(usually denoted by lambda), and the two methods we described above.</p>
<p>Our .cpp implementation looks like:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;prox_l2sq.h&quot;</span><span class="cp"></span>

<span class="n">ProxL2Sq</span><span class="o">::</span><span class="n">ProxL2Sq</span><span class="p">(</span><span class="kt">double</span> <span class="n">strength</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">strength</span> <span class="o">=</span> <span class="n">strength</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">double</span> <span class="n">ProxL2Sq</span><span class="o">::</span><span class="n">value</span><span class="p">(</span><span class="n">ArrayDouble</span> <span class="o">&amp;</span><span class="n">coeffs</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">coeffs</span><span class="p">.</span><span class="n">normsq</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">ProxL2Sq</span><span class="o">::</span><span class="n">call</span><span class="p">(</span><span class="n">ArrayDouble</span> <span class="o">&amp;</span><span class="n">coeffs</span><span class="p">,</span> <span class="kt">double</span> <span class="n">step</span><span class="p">,</span> <span class="n">ArrayDouble</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">coeffs</span><span class="p">.</span><span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">step</span> <span class="o">*</span> <span class="n">strength</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In mlpp these files are stored in /src folder</p>
</div>
<div class="section" id="link-it-with-python">
<h3>Link it with Python<a class="headerlink" href="#link-it-with-python" title="Permalink to this headline">¶</a></h3>
<div class="section" id="create-swig-file">
<h4>Create SWIG file<a class="headerlink" href="#create-swig-file" title="Permalink to this headline">¶</a></h4>
<p>Now that our proximal operator is defined in C++ we need to make it available
in Python. We do it thanks to <a class="reference external" href="http://www.swig.org/Doc3.0/">SWIG</a>.
Hence we have to create a .i file. In mlpp we store them in /swig folder.</p>
<p>This .i file looks a lot like our .h file.</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">std_shared_ptr</span><span class="p">.</span><span class="n">i</span><span class="o">&gt;</span>
<span class="o">%</span><span class="n">shared_ptr</span><span class="p">(</span><span class="n">ProxL2Sq</span><span class="p">);</span>

<span class="o">%</span><span class="p">{</span>
<span class="cp">#include</span> <span class="cpf">&quot;prox_l2sq.h&quot;</span><span class="cp"></span>
<span class="o">%</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">ProxL2Sq</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">ProxL2Sq</span><span class="p">(</span><span class="kt">double</span> <span class="n">strength</span><span class="p">);</span>
    <span class="kt">double</span> <span class="nf">value</span><span class="p">(</span><span class="n">ArrayDouble</span> <span class="o">&amp;</span><span class="n">coeffs</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="kt">void</span> <span class="nf">call</span><span class="p">(</span><span class="n">ArrayDouble</span> <span class="o">&amp;</span><span class="n">coeffs</span><span class="p">,</span> <span class="kt">double</span> <span class="n">step</span><span class="p">,</span> <span class="n">ArrayDouble</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">set_strength</span><span class="p">(</span><span class="kt">double</span> <span class="n">strength</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
</div>
<p>In this file our goal is to explain to Python what it can do with this class. In
our example it will be able to instantiate it by calling its constructor
with a double, and call three methods, <code class="xref py py-obj docutils literal"><span class="pre">value</span></code>, <code class="xref py py-obj docutils literal"><span class="pre">call</span></code> and <code class="xref py py-obj docutils literal"><span class="pre">set_strength</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>There is no interest in mentioning here any private method or attribute of
the class as this is what Python see and Python would not be able to call
them.</li>
<li>We need to include the file in which is declared the class we are talking
about in the .i file. This what we do with <code class="xref py py-obj docutils literal"><span class="pre">#include</span> <span class="pre">&quot;prox_l2sq.h&quot;</span></code>.</li>
<li>Finally, as we will want to share our proximal operator and as it might be
used by several objects, we wrap it in class from the standard library: the
shared pointer. To make SWIG aware that this class will be used with shared
pointers we must add <code class="xref py py-obj docutils literal"><span class="pre">%shared_ptr(ProxL2Sq);</span></code> which must be done after
<code class="xref py py-obj docutils literal"><span class="pre">%include</span> <span class="pre">&lt;std_shared_ptr.i&gt;</span></code>.</li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In mlpp our ProxL2Sq class is not really identical as it inherits
from Prox abstract class. Hence some of this logic might not be present in
the exact same file. Everything that concerns prox, is imported through
<code class="xref py py-obj docutils literal"><span class="pre">prox_module.i</span></code>.</p>
</div>
</div>
<div class="section" id="reference-it-in-python-build">
<h4>Reference it in Python build<a class="headerlink" href="#reference-it-in-python-build" title="Permalink to this headline">¶</a></h4>
<p>Now that we have written our .i file we should add our files to our python
script that builds the extension : <code class="xref py py-obj docutils literal"><span class="pre">setup.py</span></code>.</p>
<p>Most of the time, we add a file that belongs to a module that has already
been created. In this case we only need to add its source files at the right
place in <code class="xref py py-obj docutils literal"><span class="pre">setup.py</span></code>.</p>
<p>Let&#8217;s supposed we already had two prox in our module (abstract class Prox and
prox L1), we need to add <code class="xref py py-obj docutils literal"><span class="pre">prox_l2sq.cpp</span></code> and <code class="xref py py-obj docutils literal"><span class="pre">prox_l2sq.h</span></code> that we have just
created at the following place.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">prox_core_info</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;cpp_files&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;prox.cpp&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;prox_l1.cpp&quot;</span><span class="p">,</span>
<span class="hll">                  <span class="s2">&quot;prox_l2sq.cpp&quot;</span><span class="p">],</span>
</span>    <span class="s2">&quot;h_files&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;prox.h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;prox_l1.h&quot;</span><span class="p">,</span>
<span class="hll">                <span class="s2">&quot;prox_l2sq.h&quot;</span><span class="p">],</span>
</span>    <span class="s2">&quot;swig_files&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;prox_module.i&quot;</span><span class="p">,</span> <span class="p">],</span>
    <span class="s2">&quot;module_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;./mlpp/optim/prox/&quot;</span><span class="p">,</span>
    <span class="s2">&quot;extension_name&quot;</span><span class="p">:</span> <span class="s2">&quot;prox&quot;</span><span class="p">,</span>
    <span class="s2">&quot;include_modules&quot;</span><span class="p">:</span> <span class="n">base_modules</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We do not need to add <code class="xref py py-obj docutils literal"><span class="pre">prox_l2sq.i</span></code> file here as it is imported
in <code class="xref py py-obj docutils literal"><span class="pre">prox_module.i</span></code> with a <code class="xref py py-obj docutils literal"><span class="pre">%include</span></code> operator. This operator works like a
copy/paste of the code of the included file.</p>
</div>
</div>
</div>
<div class="section" id="use-class-in-python">
<h3>Use class in Python<a class="headerlink" href="#use-class-in-python" title="Permalink to this headline">¶</a></h3>
<p>Now that our C++ class is linked with Python we can import it and use its
methods that we have declared in the .i file.</p>
<p>In mlpp we always wrap C++ classes in a Python class that will call C++
object methods when it needs to perform the computations. Hence here is the
Python class we might create:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">.build.prox</span> <span class="kn">import</span> <span class="n">ProxL2Sq</span> <span class="k">as</span> <span class="n">_ProxL2sq</span>

<span class="k">class</span> <span class="nc">ProxL2Sq</span><span class="p">:</span>
    <span class="n">_attrinfos</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;strength&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;cpp_setter&quot;</span><span class="p">:</span> <span class="s2">&quot;set_strength&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">_cpp_obj_name</span> <span class="o">=</span> <span class="s2">&quot;_prox&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strength</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prox</span> <span class="o">=</span> <span class="n">_ProxL2sq</span><span class="p">(</span><span class="n">strength</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strength</span> <span class="o">=</span> <span class="n">strength</span>

    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prox</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span>
</pre></div>
</div>
<p>You might have seen that we instantiate a dictionary called <code class="xref py py-obj docutils literal"><span class="pre">_attrinfos</span></code> in
the class declaration. This dictionary is useful in many ways and you should
refer to <a class="reference internal" href="#baseclass">BaseClass</a>. Here we use one of
its functionalities: automatic set of C++ attributes. Each time <code class="xref py py-obj docutils literal"><span class="pre">strength</span></code> of
our prox will be modified, the <code class="xref py py-obj docutils literal"><span class="pre">set_strength</span></code> method of the object stored in
<code class="xref py py-obj docutils literal"><span class="pre">_prox</span></code> attribute (as specified by <code class="xref py py-obj docutils literal"><span class="pre">_cpp_obj_name</span></code> will be called with the
new value passed as argument). This allow us to have strength values of
Python and C++ that are always linked.</p>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2015, Emmanuel Bacry, Martin Bompaire, Stephane Gaiffas, Maryan Morel, Søren Poulsen.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.8.<br/>
    </p>
  </div>
</footer>
  </body>
</html>